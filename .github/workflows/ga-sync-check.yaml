# Check if GA event definitions are in sync
# NOTE: This workflow is for projects that USE ga_sync, not for ga_sync itself.
# Copy this file to your project's .github/workflows/ directory after ga_sync is published to pub.dev.

name: GA Sync Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c # v1
        with:
          sdk: stable

      # For published package, use:
      # - name: Install ga_sync
      #   run: dart pub global activate ga_sync

      # For development/testing, use local build:
      - name: Install ga_sync (from source)
        run: dart pub global activate --source path .

      - name: Setup Google credentials
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        if: env.GOOGLE_CREDENTIALS != ''
        run: echo "$GOOGLE_CREDENTIALS" > credentials.json

      - name: Check events sync
        if: env.GOOGLE_CREDENTIALS != ''
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: ga_sync check

      - name: Skip check (no credentials)
        if: env.GOOGLE_CREDENTIALS == ''
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: echo "Skipping check - GOOGLE_CREDENTIALS not configured"

      - name: Cleanup credentials
        if: always()
        run: rm -f credentials.json
